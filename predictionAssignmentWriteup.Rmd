---
title: "Prediction Assignment Writeup"
author: "datasciencespm"
date: "Friday, September 12, 2014"
output: html_document
---
[verify required packages are installed][1]
```{r setupEnvironment, message=FALSE}

# Verify required packages are installed
required.packages <- c("data.table",
                       "ggplot2",
                       "Gmisc")

new.packages <- required.packages[!(required.packages %in% 
                                    installed.packages())]

if(length(new.packages)) {
  install.packages(new.packages)
} 

# Load required packages
library(data.table)
library(ggplot2)
library(Gmisc)
library(RColorBrewer)
```

```{r loadAndCleanData, cache=TRUE}
if (!file.exists("./Data")) {
    dir.create("./Data")
    
    trainingDataURL <- 
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"

    testDataURL <-
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
    
    download.file(trainingDataURL, destfile = "./Data/trainingData.csv")
    
    download.file(testDataURL, destfile = "./Data/testData.csv")
}

loadExerciseData <- function(exerciseDataFile) {
#------------------------------------------------------------------------
#------------------------------------------------------------------------
    exerciseData <- read.csv(file = file.path("./Data",
                                              exerciseDataFile),
                             header=TRUE,
                             stringsAsFactors = FALSE)

    colnames(exerciseData) <- tolower(colnames(exerciseData))
    variableNames <- colnames(exerciseData)

    for (i in seq_len(length(variableNames))) {
        variableNames[i] <- gsub("_", "", variableNames[i])
    }
    
    colnames(exerciseData) <- variableNames
    
    exerciseData$timestamp <- exerciseData$rawtimestamppart1 + 
                              exerciseData$rawtimestamppart2*1E-6
    
    exerciseData <- 
        exerciseData[,!colnames(exerciseData) %in% c("x",
                                                     "rawtimestamppart1",
                                                     "rawtimestamppart2")]

    return(exerciseData)
}

trainingData <- loadExerciseData("trainingData.csv")

testData <- loadExerciseData("testData.csv")
```

# of training data rows: `r nrow(trainingData)`
# of test data rows: `r nrow(testData)`

```{r removeNAData, comment=""}
calculateMissingDataStatistics <- function(trainingData) {
    variableNames <- colnames(trainingData)
    
    naData <- data.frame()
    for (curVar in variableNames) {
        naData <- 
            rbind(naData,
                  data.frame(variable=curVar,
                             nacount=sum(is.na(trainingData[,curVar]))))
    }

    naData$nacount <- 100*(naData$nacount / nrow(trainingData))
    
    return(naData)
}

naData <- calculateMissingDataStatistics(trainingData)
summary(naData$nacount)

naData <- subset(naData, naData$nacount > 0)
naVariables <- as.character(naData$variable)

trainingData <- trainingData[,!(colnames(trainingData) %in% naVariables)]

naData <- calculateMissingDataStatistics(trainingData)
summary(naData$nacount)
```

```{r evaluateDataWindowSizePart1, results='asis'}
## ###########################################################################
## DEFINE FUNCTIONS
## ###########################################################################
initializeDataWindowIndex <- function(trainingData,
                                      minLength = 0,
                                      maxLength = NA) {
#------------------------------------------------------------------------
# Initializes a compound list that contains the data frame row indices
# corresponding to a specific data window
#------------------------------------------------------------------------
    weightLiftingClasse <- unique(trainingData$classe)
    
    dataWindow <- list();
    for (curClasse in weightLiftingClasse) {
        dataWindow[[curClasse]] <- list();    
    }
    
    startOfNewWindow <- which(trainingData$newwindow == "yes")

    numDataWindows <- length(startOfNewWindow)
    
    for (n in seq(0, numDataWindows)) {
        if (n == 0) {
            curWindowIdx <- 1:(startOfNewWindow[1] - 1)
        }
        else if (n == numDataWindows) {
            curWindowIdx <- startOfNewWindow[n]:nrow(trainingData)
        }
        else
        {
            curWindowIdx <- startOfNewWindow[n]:(startOfNewWindow[n + 1]- 1)
        }
        curClasse <- trainingData$classe[curWindowIdx[1]]
    
        minLengthTest <- length(curWindowIdx) >= minLength

        if (is.na(maxLength)) {
            maxLengthTest <- TRUE
        }
        else {
            maxLengthTest <- length(curWindowIdx) <= maxLength
        }

        if (minLengthTest & maxLengthTest) {
            dataWindow[[curClasse]][[length(dataWindow[[curClasse]]) + 1]] <- 
                curWindowIdx            
        }
    }
    
    return(dataWindow)
}

computeDataWindowCount <- function(dataWindow) {
#------------------------------------------------------------------------
#------------------------------------------------------------------------
    dataWindowCount <- data.frame()
    for (curClasse in names(dataWindow)) {
        dataWindowCount <- rbind(dataWindowCount,
                                 data.frame(classe=curClasse,
                                            count=length(dataWindow[[curClasse]])))
    }

    dataWindowCount$classe <- as.character(dataWindowCount$classe)
    
    return(dataWindowCount)
}

#------------------------------------------------------------------------
#------------------------------------------------------------------------
computeDataWindowSize <- function(dataWindow) {
    dataWindowSize <- data.frame()

    for (curClasse in names(dataWindow)) {
        for (curIdx in dataWindow[[curClasse]]) {
            dataWindowSize <- 
                rbind(dataWindowSize,data.frame(classe=curClasse,
                                                windowsize=length(curIdx)))
        }
    }
    
    return(dataWindowSize)
}

computeDataWindowSizeSummary <- function(dataWindowSize) {
#----------------------------------------------------------------------
#----------------------------------------------------------------------
    dataWindowSizeSummary <- data.frame()
    for (curClasse in unique(dataWindowSize$classe)) {
        curCounts <- subset(dataWindowSize,
                            dataWindowSize$classe==curClasse)
    
        curSummary <- summary(curCounts$windowsize)
    
        dataWindowSizeSummary <- 
            rbind(dataWindowSizeSummary,
                  data.frame(classe=curClasse,
                             min=curSummary[1],
                             firstquantile=curSummary[2],
                             median=curSummary[3],
                             mean=curSummary[4],
                             thirdquantile=curSummary[5],
                             max=curSummary[6]))
    }
    rownames(dataWindowSizeSummary) <- NULL
    
    dataWindowSizeSummary$classe <- as.character(dataWindowSizeSummary$classe)    
    
    return(dataWindowSizeSummary)
}

## ###########################################################################
dataWindow <- initializeDataWindowIndex(trainingData)

dataWindowSize = computeDataWindowSize(dataWindow)

ggplot(dataWindowSize, aes(x=windowsize, colour=classe, fill=classe)) + 
      geom_density() + scale_colour_brewer(palette="Dark2") + 
      scale_fill_brewer(palette="Dark2") +
      facet_wrap(~classe) + ggtitle("Original Data Window Size")

dataWindowSizeSummary <- computeDataWindowSizeSummary(dataWindowSize)

htmlTable(dataWindowSizeSummary,
          caption="Original Data Window Size Statistics",
          rowlabel="",)
```

```{r evaluateDataWindowSizePart2, results='asis'}
dataWindow <- initializeDataWindowIndex(trainingData,
                                        max(dataWindowSizeSummary$min),
                                        min(dataWindowSizeSummary$max))

dataWindowSize = computeDataWindowSize(dataWindow)

ggplot(dataWindowSize, aes(x=windowsize, colour=classe, fill=classe)) + 
      geom_density() + scale_colour_brewer(palette="Dark2") + 
      scale_fill_brewer(palette="Dark2") +
      facet_wrap(~classe) + ggtitle("Updated Data Window Size")

dataWindowSizeSummary <- computeDataWindowSizeSummary(dataWindowSize)

htmlTable(dataWindowSizeSummary,
          caption="Updated Data Window Size Statistics",
          rowlabel="",)
```
  
  
```{r constrainDataWindowSize}
cleanTrainingData <- data.frame()

variableNames <- colnames(trainingData)

for (curClasse in names(dataWindow)) {
    dataWindowNumber <- 1
    
    for (curDataWindowIdx in dataWindow[[curClasse]]) {
        curDataWindow <- trainingData[curDataWindowIdx,]

        curDataWindow <- 
            curDataWindow[,!colnames(curDataWindow) %in% c("numwindow")]

        curDataWindow$timestamp <- 
            curDataWindow$timestamp - curDataWindow$timestamp[1]
        
        curDataWindow$datawindownumber <- dataWindowNumber
        
        cleanTrainingData <- rbind(cleanTrainingData,
                                   curDataWindow)

        dataWindowNumber <- dataWindowNumber + 1
    }
}
```

[1]: http://stackoverflow.com/questions/9341635/how-can-i-check-for-installed-r-packages-before-running-install-packages
[2]: http://stackoverflow.com/questions/4605206/drop-columns-r-data-frame
[3]: http://stackoverflow.com/questions/5430338/remove-data-frame-row-names-when-using-xtable
[4]: http://tex.stackexchange.com/questions/165329/controlling-formatting-options-for-xtable
[5]: http://stackoverflow.com/questions/8446218/how-to-see-an-html-page-on-github-as-a-normal-rendered-html-page-to-see-preview
