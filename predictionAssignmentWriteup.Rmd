---
title: "Prediction Assignment Writeup"
author: "datasciencespm"
date: "Friday, September 12, 2014"
output: html_document
---
[verify required packages are installed][1]
```{r setupEnvironment, message=FALSE}

# Verify required packages are installed
required.packages <- c("data.table",
                       "ggplot2",
                       "Gmisc")

new.packages <- required.packages[!(required.packages %in% 
                                    installed.packages())]

if(length(new.packages)) {
  install.packages(new.packages)
} 

# Load required packages
library(data.table)
library(ggplot2)
library(Gmisc)
library(RColorBrewer)
```

```{r loadAndCleanData, cache=TRUE}
if (!file.exists("./Data")) {
    dir.create("./Data")
    
    trainingDataURL <- 
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"

    testDataURL <-
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
    
    download.file(trainingDataURL, destfile = "./Data/trainingData.csv")
    
    download.file(testDataURL, destfile = "./Data/testData.csv")
}

trainingData <- read.csv(file = "./Data/trainingData.csv",
                         header=TRUE,
                         stringsAsFactors = FALSE)

colnames(trainingData) <- tolower(colnames(trainingData))
variableNames <- colnames(trainingData)

for (i in seq_len(length(variableNames))) {
    variableNames[i] <- gsub("_", "", variableNames[i])
}

colnames(trainingData) <- variableNames

trainingData$timestamp <- trainingData$rawtimestamppart1 + 
                          trainingData$rawtimestamppart2*1E-6
```

```{r removeNAData, comment=""}
calculateMissingDataStatistics <- function(trainingData) {
    variableNames <- colnames(trainingData)
    
    naData <- data.frame()
    for (curVar in variableNames) {
        naData <- 
            rbind(naData,
                  data.frame(variable=curVar,
                             nacount=sum(is.na(trainingData[,curVar]))))
    }

    naData$nacount <- 100*(naData$nacount / nrow(trainingData))
    
    return(naData)
}

naData <- calculateMissingDataStatistics(trainingData)
summary(naData$nacount)

naData <- subset(naData, naData$nacount > 0)
naVariables <- as.character(naData$variable)

trainingData <- trainingData[,!(colnames(trainingData) %in% naVariables)]

naData <- calculateMissingDataStatistics(trainingData)
summary(naData$nacount)
```

```{r initializeDataWindowIndex, results='asis'}
startOfNewWindow <- which(trainingData$newwindow == "yes")

initializeDataWindowIndex <- function(trainingData,
                                      minLength = 0) {
#------------------------------------------------------------------------
# Initializes a compound list that contains the data frame row indices
# corresponding to a specific data window
#------------------------------------------------------------------------
    weightLiftingClasse <- unique(trainingData$classe)
    
    dataWindow <- list();
    for (curClasse in weightLiftingClasse) {
        dataWindow[[curClasse]] <- list();    
    }
    
    numDataWindows <- length(startOfNewWindow)
    
    for (n in seq(0, numDataWindows)) {
        if (n == 0) {
            curWindowIdx <- 1:(startOfNewWindow[1] - 1)
        }
        else if (n == numDataWindows) {
            curWindowIdx <- startOfNewWindow[n]:nrow(trainingData)
        }
        else
        {
            curWindowIdx <- startOfNewWindow[n]:(startOfNewWindow[n + 1]- 1)
        }
        curClasse <- trainingData$classe[curWindowIdx[1]]
    
        if (length(curWindowIdx) >= minLength) {
            dataWindow[[curClasse]][[length(dataWindow[[curClasse]]) + 1]] <- 
                curWindowIdx            
        }
    }
    
    return(dataWindow)
}

dataWindow <- initializeDataWindowIndex(trainingData)

computeDataWindowCount <- function(dataWindow) {
#------------------------------------------------------------------------
#------------------------------------------------------------------------
    dataWindowCount <- data.frame()
    for (curClasse in names(dataWindow)) {
        dataWindowCount <- rbind(dataWindowCount,
                                 data.frame(classe=curClasse,
                                            count=length(dataWindow[[curClasse]])))
    }

    dataWindowCount$classe <- as.character(dataWindowCount$classe)
    
    return(dataWindowCount)
}

dataWindowCount <- computeDataWindowCount(dataWindow)

htmlTable(dataWindowCount,
          caption="Class Data Window Count",
          rowlabel="",)
```

```{r evaluateDataWindowSizePart1, comment=""}
#------------------------------------------------------------------------
#------------------------------------------------------------------------
computeDataWindowSize <- function(dataWindow) {
    dataWindowSize <- data.frame()

    for (curClasse in names(dataWindow)) {
        for (curIdx in dataWindow[[curClasse]]) {
            dataWindowSize <- 
                rbind(dataWindowSize,data.frame(classe=curClasse,
                                                windowsize=length(curIdx)))
        }
    }
    
    return(dataWindowSize)
}

dataWindowSize = computeDataWindowSize(dataWindow)

ggplot(dataWindowSize, aes(x=windowsize, fill=classe)) + 
      geom_histogram(binwidth=1) + 
      scale_fill_brewer(palette="Dark2") + 
      facet_wrap(~classe)

summary(dataWindowSize$windowsize)

summary(dataWindowSize[which(dataWindowSize$windowsize > 2),c("windowsize")])
```

```{r evaluateDataWindowSizePart2, comment="", results='asis'}
dataWindow <- initializeDataWindowIndex(trainingData, 12)

dataWindowSize = computeDataWindowSize(dataWindow)

ggplot(dataWindowSize, aes(x=windowsize, fill=classe)) + 
      geom_histogram(binwidth=1) + 
      scale_fill_brewer(palette="Dark2") + 
      facet_wrap(~classe)

summary(dataWindowSize$windowsize)

dataWindowCount <- computeDataWindowCount(dataWindow)

htmlTable(dataWindowCount,
          caption="Class Data Window Count",
          rowlabel="",)
```

```{r removeSmallDataWindows}
cleanTrainingData <- data.frame()

variableNames <- colnames(trainingData)

for (curClasse in names(dataWindow)) {
    for (curDataWindowIdx in dataWindow[[curClasse]]) {
        curDataWindow <- trainingData[curDataWindowIdx,]
        
        curDataWindow$timestamp <- 
            curDataWindow$timestamp - curDataWindow$timestamp[1]
        

        
    }
}
```

[1]: http://stackoverflow.com/questions/9341635/how-can-i-check-for-installed-r-packages-before-running-install-packages
[2]: http://stackoverflow.com/questions/4605206/drop-columns-r-data-frame
[3]: http://stackoverflow.com/questions/5430338/remove-data-frame-row-names-when-using-xtable
[4]: http://tex.stackexchange.com/questions/165329/controlling-formatting-options-for-xtable
[5]: http://stackoverflow.com/questions/8446218/how-to-see-an-html-page-on-github-as-a-normal-rendered-html-page-to-see-preview
